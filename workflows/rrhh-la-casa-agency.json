{"updatedAt":"2026-02-13T13:31:30.091Z","createdAt":"2026-02-12T14:36:10.368Z","id":"7ELtvdYY0xq2eOU4","name":"La Casa Agency RH - Auto completar Google Sheet","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{},"id":"88edb2d9-6fc3-4c7b-a4ee-0fc524ff91d7","name":"Ejecutar Manual","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-12912,3904]},{"parameters":{"jsCode":"const { pdfs } = $input.first().json;\nreturn pdfs.map(p =\u003e ({ json: { ...p } }));"},"id":"085b8ae0-21c5-4b11-9b43-9be35a3e8343","name":"Split PDFs","type":"n8n-nodes-base.code","typeVersion":2,"position":[-12464,3904]},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":3}]}},"id":"f63a4396-84a6-45e3-b267-528246b62e32","name":"Cron 3min","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-12912,4320]},{"parameters":{"url":"=https://graph.microsoft.com/v1.0/me/drive/root:/Base de datos/{{ $now.year }}:/search(q=\u0027.pdf\u0027)?$top=200\u0026$select=id,name,size,lastModifiedDateTime,webUrl,parentReference,file","authentication":"predefinedCredentialType","nodeCredentialType":"microsoftOneDriveOAuth2Api","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"d633d30a-2875-479f-b55e-e740e38ce331","name":"1. Buscar PDFs OneDrive","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-12688,4320],"credentials":{"microsoftOneDriveOAuth2Api":{"id":"OF2rMJ4ZrCjjkJwn","name":"Microsoft Drive account"}},"notes":"OneDrive Personal: /me/drive/\nPara SharePoint: /sites/{siteId}/drives/{driveId}/root:/...\n$top=200 para paginacion. Si hay mas, usar @odata.nextLink"},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Parsear TODOS los PDFs y devolver UN SOLO item con array\n// Esto permite leer la Sheet 1 sola vez\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst firstResponse = $input.first().json;\n\n// Seguir paginacion de OneDrive (@odata.nextLink) para ir mas alla de los 200 resultados\nlet files = firstResponse.value || [];\nlet nextLink = firstResponse[\u0027@odata.nextLink\u0027];\n\nwhile (nextLink) {\n  try {\n    const pageResp = await this.helpers.requestWithAuthentication.call(\n      this, \u0027microsoftOneDriveOAuth2Api\u0027, {\n        method: \u0027GET\u0027,\n        uri: nextLink,\n        json: true\n      }\n    );\n    files = files.concat(pageResp.value || []);\n    nextLink = pageResp[\u0027@odata.nextLink\u0027] || null;\n  } catch (e) {\n    console.log(\u0027Pagination error:\u0027, e.message);\n    break;\n  }\n}\n\n\nconst ESTADO_MAP = {\n  \u0027CITADOS\u0027: \u0027CITADO\u0027,\n  \u0027DESCARTADOS\u0027: \u0027DESCARTADO\u0027,\n  \u0027CITAS FUERA JORNADA\u0027: \u0027CITA_FUERA_JORNADA\u0027\n};\n\nfunction normalizeName(str) {\n  return (str || \u0027\u0027)\n    .normalize(\u0027NFD\u0027).replace(/[\\u0300-\\u036f]/g, \u0027\u0027)\n    .toLowerCase()\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n}\n\nconst pdfs = [];\n\nfor (const file of files) {\n  if (!file.name || !file.name.toLowerCase().endsWith(\u0027.pdf\u0027)) continue;\n  \n  const parentPath = decodeURIComponent(file.parentReference?.path || \u0027\u0027);\n  const fullPath = parentPath + \u0027/\u0027 + file.name;\n  \n  const afterBase = parentPath.split(\u0027/2026/\u0027);\n  if (afterBase.length \u003c 2) continue;\n  \n  const pathParts = afterBase[1].split(\u0027/\u0027);\n  if (pathParts.length \u003c 4) continue;\n  \n  const posicion = pathParts[0] || \u0027\u0027;\n  const ciudad = pathParts[1] || \u0027\u0027;\n  const mes = pathParts[2] || \u0027\u0027;\n  const semana = pathParts[3] || \u0027\u0027;\n  const subcarpeta = pathParts[4] || \u0027\u0027;\n  \n  let estado = \u0027PENDIENTE\u0027;\n  for (const [carpeta, est] of Object.entries(ESTADO_MAP)) {\n    if (subcarpeta.toUpperCase().includes(carpeta.toUpperCase())) {\n      estado = est;\n      break;\n    }\n  }\n  \n  let nombreArchivo = file.name\n    .replace(/\\.pdf$/i, \u0027\u0027)\n    .replace(/^CV[_\\s-]*/i, \u0027\u0027)\n    .replace(/[_-]/g, \u0027 \u0027)\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n  \n  const nombreFormateado = nombreArchivo\n    .replace(/\\b\\w/g, c =\u003e c.toUpperCase());\n  \n  pdfs.push({\n    fileId: file.id,\n    fileName: file.name,\n    filePath: fullPath,\n    fileSize: file.size,\n    lastModified: file.lastModifiedDateTime,\n    webUrl: file.webUrl || \u0027\u0027,\n    posicion, ciudad, mes, semana, subcarpeta, estado,\n    nombreArchivo: nombreFormateado,\n    nombreNormalizado: normalizeName(nombreFormateado)\n  });\n}\n\n// Devolver UN SOLO item con el array de PDFs\nreturn [{ json: { pdfs, totalPdfs: pdfs.length, empty: pdfs.length === 0 } }];"},"id":"b3a57c7d-e44b-49fa-bb81-e804b88fd762","name":"2. Parsear Rutas","type":"n8n-nodes-base.code","typeVersion":2,"position":[-12464,4320]},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"c1","leftValue":"={{ $json.totalPdfs }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"0d8c1e4e-3e8a-4cb9-aa8b-13c53206aa3c","name":"Hay archivos?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-12240,4320]},{"parameters":{"operation":"getAll","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"}},"id":"5428f502-46f6-434d-a872-427937196057","name":"3. Leer Sheet COMPLETA","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-12016,4320],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}},"onError":"continueRegularOutput","notes":"Lee TODA la sheet de una sola vez para evitar multiples llamadas API"},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// COMPARAR PDFs vs Sheet - BIDIRECCIONAL\n// Usa Log para tracking de sync (no columnas ocultas)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction norm(str) {\n  return (str || \u0027\u0027)\n    .normalize(\u0027NFD\u0027).replace(/[\\u0300-\\u036f]/g, \u0027\u0027)\n    .toLowerCase()\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n}\n\nconst sheetRows = $(\u00273. Leer Sheet COMPLETA\u0027).all().map(i =\u003e i.json);\nconst logRows = $(\u00273b. Leer Log\u0027).all().map(i =\u003e i.json);\n\n// Indice Sheet por nombre\nconst sheetByName = {};\nfor (let i = 0; i \u003c sheetRows.length; i++) {\n  const row = sheetRows[i];\n  const key = norm(row.NOMBRE || \u0027\u0027);\n  if (key \u0026\u0026 !sheetByName[key]) {\n    sheetByName[key] = { ...row, _rowIndex: i + 2 };\n  }\n}\n\n// Indice Log: ultimo estado sincronizado por nombre\n// El Log tiene: timestamp, nombre, accion, situacion_anterior, situacion_nueva\nconst lastSync = {};\nfor (const log of logRows) {\n  const key = norm(log.nombre || \u0027\u0027);\n  if (key) {\n    // El ultimo log entry gana (estan en orden cronologico)\n    lastSync[key] = norm(log.situacion_nueva || \u0027\u0027);\n  }\n}\n\nconst pdfs = $(\u00272. Parsear Rutas\u0027).first().json.pdfs || [];\nconst results = [];\nconst yaVistos = new Set();\nlet stats = { insertar: 0, actualizar_sheet: 0, mover_onedrive: 0, skip: 0 };\n\nfor (const pdf of pdfs) {\n  const batchKey = pdf.nombreNormalizado + \u0027|\u0027 + norm(pdf.posicion);\n  if (yaVistos.has(batchKey)) { stats.skip++; continue; }\n  yaVistos.add(batchKey);\n\n  const match = sheetByName[pdf.nombreNormalizado] || null;\n  \n  if (!match) {\n    results.push({ json: { ...pdf, accion: \u0027INSERTAR\u0027 }});\n    stats.insertar++;\n    continue;\n  }\n  \n  const sheetEstado = norm(match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027);\n  const onedriveEstado = norm(pdf.estado);\n  const ultimoSync = lastSync[pdf.nombreNormalizado] || \u0027\u0027;\n  \n  if (sheetEstado === onedriveEstado) {\n    stats.skip++;\n    continue;\n  }\n  \n  // HAY DIFERENCIA\n  if (!ultimoSync || ultimoSync === sheetEstado) {\n    // OneDrive cambio â†’ actualizar Sheet\n    results.push({ json: {\n      ...pdf, accion: \u0027ACTUALIZAR_SHEET\u0027,\n      situacionAnterior: match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027,\n      matchNombre: match.NOMBRE,\n      matchRowIndex: match._rowIndex\n    }});\n    stats.actualizar_sheet++;\n  } else if (ultimoSync === onedriveEstado) {\n    // Sheet cambio â†’ mover en OneDrive\n    const nuevoEstado = (match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027).trim();\n    results.push({ json: {\n      ...pdf, accion: \u0027MOVER_ONEDRIVE\u0027,\n      nuevoEstado,\n      situacionAnterior: pdf.estado,\n      matchNombre: match.NOMBRE,\n      matchRowIndex: match._rowIndex\n    }});\n    stats.mover_onedrive++;\n  } else {\n    // Conflicto â†’ Sheet gana\n    const nuevoEstado = (match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027).trim();\n    results.push({ json: {\n      ...pdf, accion: \u0027MOVER_ONEDRIVE\u0027,\n      nuevoEstado, situacionAnterior: pdf.estado,\n      matchNombre: match.NOMBRE, matchRowIndex: match._rowIndex,\n      _conflicto: true\n    }});\n    stats.mover_onedrive++;\n  }\n}\n\nif (results.length === 0) {\n  return [{ json: { accion: \u0027NINGUNA\u0027, _skip: true, _resumen: JSON.stringify(stats) }}];\n}\nresults[0].json._resumen = JSON.stringify(stats);\nreturn results;"},"id":"7c6e7658-e164-4d56-9e78-2720602dde0c","name":"4. Comparar PDF vs Sheet","type":"n8n-nodes-base.code","typeVersion":2,"position":[-11568,4320]},{"parameters":{"rules":{"values":[{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"INSERTAR","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"NUEVO"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"ACTUALIZAR_SHEET","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"ACTUALIZAR_SHEET"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"MOVER_ONEDRIVE","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"MOVER_ONEDRIVE"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"NINGUNA","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"SKIP"}]},"options":{}},"id":"8d3f5bd6-4325-4f71-954c-fb0bd427efbb","name":"5. Switch Accion","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-11344,4288]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":1135598434,"mode":"list","cachedResultName":"BASE DE DATOS 2026 BCN","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM/edit#gid=1135598434"},"columns":{"mappingMode":"defineBelow","value":{"MES":"={{ $json.MES }}","NOMBRE":"={{ $json.NOMBRE }}","FORMATO":"={{ $json.FORMATO }}","OFICINA":"={{ $json.OFICINA }}"," RESIDENCIA":"={{ $json[\u0027 RESIDENCIA\u0027] }}","FECHA":"={{ $json.FECHA }}","HORA":"={{ $json.HORA }}","CORREO":"={{ $json.CORREO }}","TELÃ‰FONO":"={{ $json[\u0027TELÃ‰FONO\u0027] }}","FUENTE":"={{ $json.FUENTE }}","CONFIRMACIÃ“N":"={{ $json[\u0027CONFIRMACIÃ“N\u0027] }}","CITADO POR":"={{ $json[\u0027CITADO POR\u0027] }}","ASISTENCIA":"={{ $json.ASISTENCIA }}","ENTREVISTADO POR":"={{ $json[\u0027ENTREVISTADO POR\u0027] }}","MOTIVO DESCARTE":"={{ $json[\u0027MOTIVO DESCARTE\u0027] }}","MAIL DESCARTE":"={{ $json[\u0027MAIL DESCARTE\u0027] }}","COMENTARIOS":"={{ $json.COMENTARIOS }}","SITUACIÃ“N":"={{ $json[\u0027SITUACIÃ“N\u0027] }}","POSICIÃ“N":"={{ $json[\u0027POSICIÃ“N\u0027] }}","INICIO":"={{ $json.INICIO }}","FIN":"={{ $json.FIN }}","CAUSA":"={{ $json.CAUSA }}"}},"options":{"cellFormat":"USER_ENTERED"}},"id":"1543382f-6a6d-46e3-9a33-8a085d66f077","name":"7a. Insertar en Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-10896,4320],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"jsCode":"const item = $input.first().json;\n\nreturn [{ json: {\n  NOMBRE: item.matchNombre || item.nombreArchivo,\n  \u0027SITUACIÃ“N\u0027: item.estado,\n  _accion: \u0027ACTUALIZAR_SHEET\u0027,\n  _situacionAnterior: item.situacionAnterior,\n  _fileName: item.fileName\n} }];"},"id":"3323d854-39db-4b77-a121-1638415867ea","name":"6e. Preparar Actualizacion","type":"n8n-nodes-base.code","typeVersion":2,"position":[-11120,4512]},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":1135598434,"mode":"list","cachedResultName":"BASE DE DATOS 2026 BCN","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM/edit#gid=1135598434"},"columns":{"mappingMode":"autoMapInputData","value":null,"matchingColumns":["NOMBRE"],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false,"ignoreAdditionalFields":true},"options":{"cellFormat":"USER_ENTERED"}},"id":"b977c9ef-3619-4819-94b2-72c92eecc9bc","name":"7b. Actualizar en Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-10896,4512],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":"Log","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"timestamp":"={{ $now.toISO() }}","nombre":"={{ $json.NOMBRE || \u0027\u0027 }}","accion":"={{ $json._accion || \u0027DESCONOCIDA\u0027 }}","situacion_anterior":"={{ $json._situacionAnterior || \u0027N/A\u0027 }}","situacion_nueva":"={{ $json[\u0027SITUACIÃ“N\u0027] || \u0027\u0027 }}","posicion":"={{ $json[\u0027POSICIÃ“N\u0027] || \u0027\u0027 }}","archivo":"={{ $json._fileName || \u0027\u0027 }}"},"matchingColumns":[],"schema":[{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nombre","displayName":"nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"accion","displayName":"accion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"situacion_anterior","displayName":"situacion_anterior","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"situacion_nueva","displayName":"situacion_nueva","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"posicion","displayName":"posicion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"archivo","displayName":"archivo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"cellFormat":"USER_ENTERED"}},"id":"ee31d0cb-148f-4f03-95d9-b2833dbf6118","name":"8. Log Cambio","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-10672,4320],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"c2","leftValue":"={{ $json[\u0027SITUACIÃ“N\u0027] }}","rightValue":"CITADO","operator":{"type":"string","operation":"equals"}},{"id":"c3","leftValue":"={{ $json._accion }}","rightValue":"INSERTAR","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"id":"f488e1e2-16a5-489a-a376-de5a8d64291f","name":"9. Es citado nuevo?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-10448,4320],"notes":"Lanza WF2 si:\n- Estado es CITADO (cambio de carpeta)\n- O es un insert nuevo con estado CITADO\nEvita lanzar WF2 para candidatos ya procesados"},{"parameters":{"workflowId":{"__rl":true,"value":"CONFIGURAR_WF2_WORKFLOW_ID","mode":"id"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{}},"id":"b8beace2-6b6c-402f-a7bd-505514cfb215","name":"10. Lanzar WF2 WhatsApp","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-10224,4320]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO UNIFICADO: Descargar PDF + Extraer IA + Preparar fila\n// Un solo Code node para evitar paired item issues de n8n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst rutaData = $input.first().json;\nconst API_KEY = $env.OPENAI_API_KEY; // Configurar en Settings \u003e Environment Variables de n8n // â† CAMBIAR POR TU API KEY\n\n// --- 1. Descargar PDF de OneDrive ---\nlet pdfBase64 = \u0027\u0027;\ntry {\n  const downloadResp = await this.helpers.requestWithAuthentication.call(\n    this, \u0027microsoftOneDriveOAuth2Api\u0027, {\n      method: \u0027GET\u0027,\n      uri: \u0027https://graph.microsoft.com/v1.0/me/drive/items/\u0027 + rutaData.fileId + \u0027/content\u0027,\n      encoding: null,\n      resolveWithFullResponse: true\n    }\n  );\n  pdfBase64 = Buffer.from(downloadResp.body).toString(\u0027base64\u0027);\n} catch (e) {\n  // Si falla la descarga, continuamos solo con el nombre del archivo\n  console.log(\u0027Download failed:\u0027, e.message);\n}\n\n// --- 2. Llamar GPT-4o via OpenAI ---\nlet cv = {};\ntry {\n  const userContent = pdfBase64\n    ? [\n        { type: \u0027file\u0027, file: { filename: rutaData.fileName, file_data: \u0027data:application/pdf;base64,\u0027 + pdfBase64 } },\n        { type: \u0027text\u0027, text: \u0027Extrae los datos de este CV de InfoJobs.\u0027 }\n      ]\n    : \u0027Extrae los datos de este CV basandote en el nombre del archivo: \u0027 + rutaData.fileName + \u0027. Solo tienes el nombre del archivo, extrae lo que puedas.\u0027;\n\n  const aiResp = await this.helpers.httpRequest({\n    method: \u0027POST\u0027,\n    url: \u0027https://api.openai.com/v1/chat/completions\u0027,\n    headers: { \u0027Authorization\u0027: \u0027Bearer \u0027 + API_KEY, \u0027Content-Type\u0027: \u0027application/json\u0027 },\n    body: {\n      model: \u0027gpt-4o\u0027,\n      messages: [\n        {\n          role: \u0027system\u0027,\n          content: `Eres un extractor de datos de CVs de InfoJobs para una empresa inmobiliaria. Extrae los datos del candidato y responde UNICAMENTE con JSON valido (sin markdown, sin backticks). Campos:\n{\n  \"nombre_completo\": \"Nombre y apellidos exactos\",\n  \"email\": \"email o vacio\",\n  \"telefono\": \"telefono con prefijo o vacio\",\n  \"residencia\": \"ciudad o barrio de residencia o vacio\",\n  \"edad\": \"numero o vacio\",\n  \"experiencia_resumen\": \"max 50 palabras\",\n  \"formacion\": \"nivel formativo principal\",\n  \"disponibilidad\": \"inmediata/parcial/especificar o vacio\",\n  \"idiomas\": \"lista de idiomas o vacio\",\n  \"carnet_conducir\": \"si/no/vacio\",\n  \"vehiculo_propio\": \"si/no/vacio\"\n}\nReglas: Si un dato no aparece, pon string vacio. NUNCA inventes datos. SOLO JSON.`\n        },\n        { role: \u0027user\u0027, content: userContent }\n      ],\n      max_tokens: 600,\n      temperature: 0\n    },\n    json: true,\n    timeout: 30000\n  });\n\n  const raw = aiResp.choices?.[0]?.message?.content || \u0027{}\u0027;\n  cv = JSON.parse(raw.replace(/```json\\n?/g, \u0027\u0027).replace(/```\\n?/g, \u0027\u0027).trim());\n} catch (e) {\n  console.log(\u0027AI extraction failed:\u0027, e.message);\n  cv = { nombre_completo: rutaData.nombreArchivo || \u0027\u0027 };\n}\n\n// --- 3. Preparar fila para Google Sheet ---\n// Decodificar URL encoding del path de OneDrive\nconst mesRaw = (rutaData.mes || \u0027\u0027).replace(/%20/g, \u0027 \u0027);\n\nconst mesMap = {\n  \u00271. ENERO\u0027: \u0027Enero\u0027, \u00272. FEBRERO\u0027: \u0027Febrero\u0027, \u00273. MARZO\u0027: \u0027Marzo\u0027,\n  \u00274. ABRIL\u0027: \u0027Abril\u0027, \u00275. MAYO\u0027: \u0027Mayo\u0027, \u00276. JUNIO\u0027: \u0027Junio\u0027,\n  \u00277. JULIO\u0027: \u0027Julio\u0027, \u00278. AGOSTO\u0027: \u0027Agosto\u0027, \u00279. SEPTIEMBRE\u0027: \u0027Septiembre\u0027,\n  \u002710. OCTUBRE\u0027: \u0027Octubre\u0027, \u002711. NOVIEMBRE\u0027: \u0027Noviembre\u0027, \u002712. DICIEMBRE\u0027: \u0027Diciembre\u0027\n};\n\nconst nombre = (cv.nombre_completo \u0026\u0026 cv.nombre_completo.length \u003e 3)\n  ? cv.nombre_completo\n  : (rutaData.nombreArchivo || \u0027Desconocido\u0027);\n\n// --- 4. Validar: sin telefono = registrar como SIN_TELEFONO ---\nconst telefono = (cv.telefono || \u0027\u0027).replace(/[^0-9]/g, \u0027\u0027);\nif (telefono.length \u003c 9) {\n  // Devolver registro especial en lugar de descartarlo silenciosamente\n  return [{ json: {\n    _accion: \u0027SIN_TELEFONO\u0027,\n    _fileName: rutaData.fileName,\n    NOMBRE: nombre,\n    OFICINA: rutaData.ciudad || \u0027\u0027,\n    \u0027SITUACIÃ“N\u0027: rutaData.estado || \u0027\u0027,\n    \u0027POSICIÃ“N\u0027: rutaData.posicion || \u0027\u0027,\n    COMENTARIOS: \u0027CV sin telÃ©fono vÃ¡lido â€” revisiÃ³n manual requerida\u0027\n  }}];\n}\n\nreturn [{\n  json: {\n    MES: mesMap[mesRaw] || mesRaw.replace(/^\\d+\\.\\s*/, \u0027\u0027) || \u0027\u0027,\n    NOMBRE: nombre,\n    FORMATO: \u0027\u0027,\n    OFICINA: rutaData.ciudad || \u0027\u0027,\n    \u0027 RESIDENCIA\u0027: cv.residencia || \u0027\u0027,\n    FECHA: new Date().toLocaleDateString(\u0027es-ES\u0027),\n    HORA: \u0027\u0027,\n    CORREO: cv.email || \u0027\u0027,\n    \u0027TELÃ‰FONO\u0027: cv.telefono || \u0027\u0027,\n    FUENTE: \u0027InfoJobs\u0027,\n    \u0027CONFIRMACIÃ“N\u0027: \u0027\u0027,\n    \u0027CITADO POR\u0027: \u0027\u0027,\n    ASISTENCIA: \u0027\u0027,\n    \u0027ENTREVISTADO POR\u0027: \u0027\u0027,\n    \u0027MOTIVO DESCARTE\u0027: \u0027\u0027,\n    \u0027MAIL DESCARTE\u0027: \u0027\u0027,\n    COMENTARIOS: [\n      cv.experiencia_resumen ? \u0027Exp: \u0027 + cv.experiencia_resumen : \u0027\u0027,\n      cv.formacion ? \u0027Form: \u0027 + cv.formacion : \u0027\u0027,\n      cv.idiomas ? \u0027Idiomas: \u0027 + cv.idiomas : \u0027\u0027,\n      cv.edad ? \u0027Edad: \u0027 + cv.edad : \u0027\u0027,\n      cv.carnet_conducir === \u0027si\u0027 ? \u0027Carnet: Si\u0027 : \u0027\u0027,\n      cv.vehiculo_propio === \u0027si\u0027 ? \u0027Vehiculo: Si\u0027 : \u0027\u0027\n    ].filter(Boolean).join(\u0027 | \u0027),\n    \u0027SITUACIÃ“N\u0027: rutaData.estado || \u0027\u0027,\n    \u0027POSICIÃ“N\u0027: rutaData.posicion || \u0027\u0027,\n    INICIO: \u0027\u0027,\n    FIN: \u0027\u0027,\n    CAUSA: \u0027\u0027,\n    _accion: \u0027INSERTAR\u0027,\n    _fileName: rutaData.fileName || \u0027\u0027\n  }\n}];"},"id":"e1158928-7218-4e04-b7b8-3e7ed14b3fb8","name":"6. Descargar + IA + Preparar","type":"n8n-nodes-base.code","typeVersion":2,"position":[-11120,4320],"notes":"Nodo unificado: descarga PDF + GPT-4o + prepara fila.\nCONFIGURAR: cambiar CONFIGURAR_OPENAI_API_KEY por tu API key real."},{"parameters":{"operation":"getAll","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"}},"id":"306254db-17a6-40c4-a330-400ff0b69c0e","name":"3b. Leer Log","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-11792,4320],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Mover archivo en OneDrive segun cambio en Sheet\nconst item = $input.first().json;\n\nconst CARPETA_MAP = {\n  \u0027CITADO\u0027: \u0027CITADOS\u0027,\n  \u0027DESCARTADO\u0027: \u0027DESCARTADOS\u0027,\n  \u0027CITA_FUERA_JORNADA\u0027: \u0027CITAS FUERA JORNADA\u0027,\n  \u0027PENDIENTE\u0027: \u0027\u0027\n};\n\nconst nuevoEstado = (item.nuevoEstado || \u0027\u0027).toUpperCase().trim();\nlet estadoNorm = \u0027PENDIENTE\u0027;\nif (nuevoEstado.includes(\u0027CITADO\u0027) \u0026\u0026 !nuevoEstado.includes(\u0027DESCARTADO\u0027) \u0026\u0026 !nuevoEstado.includes(\u0027FUERA\u0027)) {\n  estadoNorm = \u0027CITADO\u0027;\n} else if (nuevoEstado.includes(\u0027DESCARTADO\u0027) || nuevoEstado.includes(\u0027DESCARTE\u0027)) {\n  estadoNorm = \u0027DESCARTADO\u0027;\n} else if (nuevoEstado.includes(\u0027FUERA\u0027) || nuevoEstado.includes(\u0027CITA_FUERA\u0027)) {\n  estadoNorm = \u0027CITA_FUERA_JORNADA\u0027;\n}\n\nconst subcarpeta = CARPETA_MAP[estadoNorm] || \u0027\u0027;\nconst basePath = \u0027/drive/root:/Base de datos/\u0027 + new Date().getFullYear() + \u0027/\u0027 + item.posicion + \u0027/\u0027 + item.ciudad + \u0027/\u0027 + item.mes + \u0027/\u0027 + item.semana;\nconst destPath = subcarpeta ? basePath + \u0027/\u0027 + subcarpeta : basePath;\n\ntry {\n  await this.helpers.requestWithAuthentication.call(\n    this, \u0027microsoftOneDriveOAuth2Api\u0027, {\n      method: \u0027PATCH\u0027,\n      uri: \u0027https://graph.microsoft.com/v1.0/me/drive/items/\u0027 + item.fileId,\n      headers: { \u0027Content-Type\u0027: \u0027application/json\u0027 },\n      body: JSON.stringify({ parentReference: { path: destPath } })\n    }\n  );\n  \n  return [{ json: {\n    NOMBRE: item.matchNombre || item.nombreArchivo,\n    \u0027SITUACIÃ“N\u0027: estadoNorm,\n    _accion: \u0027MOVER_ONEDRIVE\u0027,\n    _situacionAnterior: item.estado,\n    _fileName: item.fileName\n  }}];\n} catch (e) {\n  throw new Error(`Move failed for ${item.fileName}: ${e.message}`);\n}}];\n}"},"id":"f4afb13d-951f-4a5e-8b30-f28d692b68d9","name":"6f. Mover en OneDrive","type":"n8n-nodes-base.code","typeVersion":2,"position":[-10896,4128]}],"connections":{"Ejecutar Manual":{"main":[[{"node":"Definir Estructura v2","type":"main","index":0}]]},"Split PDFs":{"main":[[{"node":"Subir PDFs Demo","type":"main","index":0}]]},"Cron 3min":{"main":[[{"node":"1. Buscar PDFs OneDrive","type":"main","index":0}]]},"1. Buscar PDFs OneDrive":{"main":[[{"node":"2. Parsear Rutas","type":"main","index":0}]]},"2. Parsear Rutas":{"main":[[{"node":"Hay archivos?","type":"main","index":0}]]},"Hay archivos?":{"main":[[{"node":"3. Leer Sheet COMPLETA","type":"main","index":0}]]},"3. Leer Sheet COMPLETA":{"main":[[{"node":"3b. Leer Log","type":"main","index":0}]]},"4. Comparar PDF vs Sheet":{"main":[[{"node":"5. Switch Accion","type":"main","index":0}]]},"5. Switch Accion":{"main":[[{"node":"6. Descargar + IA + Preparar","type":"main","index":0}],[{"node":"6e. Preparar Actualizacion","type":"main","index":0}],[{"node":"6f. Mover en OneDrive","type":"main","index":0}]]},"7a. Insertar en Sheet":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]},"6e. Preparar Actualizacion":{"main":[[{"node":"7b. Actualizar en Sheet","type":"main","index":0}]]},"7b. Actualizar en Sheet":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]},"8. Log Cambio":{"main":[[{"node":"9. Es citado nuevo?","type":"main","index":0}]]},"9. Es citado nuevo?":{"main":[[{"node":"10. Lanzar WF2 WhatsApp","type":"main","index":0}]]},"6. Descargar + IA + Preparar":{"main":[[{"node":"7a. Insertar en Sheet","type":"main","index":0}]]},"6f. Mover en OneDrive":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]},"3b. Leer Log":{"main":[[{"node":"4. Comparar PDF vs Sheet","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"maxConcurrency":1},"staticData":{"node:Cron 3min":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"307d4b19-d416-471f-bbc7-118e55987bdf","activeVersionId":"1bfec2ae-f3b7-4a76-84fc-f109916aa60d","versionCounter":158,"triggerCount":1,"shared":[{"updatedAt":"2026-02-12T14:36:10.368Z","createdAt":"2026-02-12T14:36:10.368Z","role":"workflow:owner","workflowId":"7ELtvdYY0xq2eOU4","projectId":"U9qViLPrGcVXNF3N","project":{"updatedAt":"2025-07-28T11:47:27.210Z","createdAt":"2025-07-28T11:21:05.569Z","id":"U9qViLPrGcVXNF3N","name":"Ivan Madrid \u003cappconexia@conexiatec.com\u003e","type":"personal","icon":null,"description":null,"creatorId":"0dadf7b3-164c-4595-8178-913217f7f722","projectRelations":[{"updatedAt":"2025-07-28T11:21:05.569Z","createdAt":"2025-07-28T11:21:05.569Z","userId":"0dadf7b3-164c-4595-8178-913217f7f722","projectId":"U9qViLPrGcVXNF3N","user":{"updatedAt":"2026-02-19T07:19:05.753Z","createdAt":"2025-07-28T11:21:04.326Z","id":"0dadf7b3-164c-4595-8178-913217f7f722","email":"appconexia@conexiatec.com","firstName":"Ivan","lastName":"Madrid","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2025-07-28T11:47:19.066Z","personalization_survey_n8n_version":"1.103.2","companySize":"\u003c20","companyType":"saas","role":"business-owner","reportedSource":"linkedin"},"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"kThy08JrV9kZk5oO","userActivatedAt":1756291854610,"npsSurvey":{"responded":true,"lastShownAt":1756054099566}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-02-19","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-02-13T12:35:43.204Z","createdAt":"2026-02-13T12:35:40.479Z","versionId":"1bfec2ae-f3b7-4a76-84fc-f109916aa60d","workflowId":"7ELtvdYY0xq2eOU4","nodes":[{"parameters":{},"id":"88edb2d9-6fc3-4c7b-a4ee-0fc524ff91d7","name":"Ejecutar Manual","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-10768,4080]},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SETUP COMPLETO - La Casa Agency RRHH\n// Genera estructura real de carpetas con PDFs de prueba\n// Periodo: Enero + Febrero 2026 (hasta semana actual)\n// Posiciones: ASESOR COMERCIAL, FINANZATE, ADMINISTRADOR DE FINCAS\n// Ciudades: BARCELONA, VALENCIA, MADRID\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst basePath = \u0027Base de datos/2026\u0027;\n\nconst pdfs = [\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ENERO - 1a SEMANA (5-10 ene)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/1a SEMANA/CITADOS`, name: \u0027CV_LUCIA_MORENO_VEGA.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/1a SEMANA/CITADOS`, name: \u0027CV_MARC_PUIG_FERRER.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_PEDRO_RUIZ_SALA.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_SANDRA_LOPEZ_MARIN.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_TONI_CAMPS_RIOS.pdf\u0027 },\n\n  // ASESOR COMERCIAL - VALENCIA\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/1. ENERO/1a SEMANA/CITADOS`, name: \u0027CV_CARMEN_NAVARRO_GIL.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/1. ENERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_JORGE_MARTINEZ_POLO.pdf\u0027 },\n\n  // FINANZATE - BARCELONA\n  { path: `${basePath}/FINANZATE/BARCELONA/1. ENERO/1a SEMANA/CITADOS`, name: \u0027CV_MIREIA_FONT_CASAS.pdf\u0027 },\n  { path: `${basePath}/FINANZATE/BARCELONA/1. ENERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_RAUL_SERRA_BOSCH.pdf\u0027 },\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ENERO - 2a SEMANA (12-17 ene)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/2a SEMANA/CITADOS`, name: \u0027CV_ALBA_TORRES_PENA.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/2a SEMANA/CITADOS`, name: \u0027CV_DANIEL_SOLER_ROCA.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_IVAN_CORTES_LUNA.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/2a SEMANA/CITAS FUERA JORNADA`, name: \u0027CV_SILVIA_GARCIA_MORA.pdf\u0027 },\n\n  // ASESOR COMERCIAL - MADRID\n  { path: `${basePath}/ASESOR COMERCIAL/MADRID/1. ENERO/2a SEMANA/CITADOS`, name: \u0027CV_ELENA_PRIETO_VALLE.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/MADRID/1. ENERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_FELIPE_HERRERO_SAEZ.pdf\u0027 },\n\n  // ADMINISTRADOR DE FINCAS - BARCELONA\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/1. ENERO/2a SEMANA/CITADOS`, name: \u0027CV_MONTSE_VIDAL_PUIG.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/1. ENERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_OSCAR_BLANCO_MAS.pdf\u0027 },\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ENERO - 3a SEMANA (19-24 ene)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/3a SEMANA/CITADOS`, name: \u0027CV_PAULA_DELGADO_REY.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/3a SEMANA/DESCARTADOS`, name: \u0027CV_ADRIAN_MENDEZ_CRUZ.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/3a SEMANA/DESCARTADOS`, name: \u0027CV_BERTA_RAMOS_ORTIZ.pdf\u0027 },\n\n  // FINANZATE - VALENCIA\n  { path: `${basePath}/FINANZATE/VALENCIA/1. ENERO/3a SEMANA/CITADOS`, name: \u0027CV_SERGIO_MOLINA_BLAS.pdf\u0027 },\n  { path: `${basePath}/FINANZATE/VALENCIA/1. ENERO/3a SEMANA/DESCARTADOS`, name: \u0027CV_CRISTINA_PONS_LLUCH.pdf\u0027 },\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ENERO - 4a SEMANA (26-31 ene)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/4a SEMANA/CITADOS`, name: \u0027CV_NEREA_CAMPOS_ABAD.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/1. ENERO/4a SEMANA/DESCARTADOS`, name: \u0027CV_VICTOR_IBARRA_LEON.pdf\u0027 },\n\n  // ADMINISTRADOR DE FINCAS - BARCELONA\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/1. ENERO/4a SEMANA/CITADOS`, name: \u0027CV_LAIA_ESTEVE_GRAU.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/1. ENERO/4a SEMANA/DESCARTADOS`, name: \u0027CV_ROGER_COSTA_PUJOL.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/1. ENERO/4a SEMANA/CITAS FUERA JORNADA`, name: \u0027CV_GEMMA_SALA_MIRO.pdf\u0027 },\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // FEBRERO - 1a SEMANA (2-7 feb)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/1a SEMANA/CITADOS`, name: \u0027CV_ARNAU_FERRER_VALLS.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/1a SEMANA/CITADOS`, name: \u0027CV_INES_PASCUAL_ROS.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_MANUEL_CRESPO_DIEZ.pdf\u0027 },\n\n  // ASESOR COMERCIAL - VALENCIA\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/2. FEBRERO/1a SEMANA/CITADOS`, name: \u0027CV_RAQUEL_GIMENEZ_PARDO.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/2. FEBRERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_DIEGO_ALONSO_FUENTES.pdf\u0027 },\n\n  // FINANZATE - BARCELONA\n  { path: `${basePath}/FINANZATE/BARCELONA/2. FEBRERO/1a SEMANA/CITADOS`, name: \u0027CV_CLARA_DOMENECH_BOU.pdf\u0027 },\n  { path: `${basePath}/FINANZATE/BARCELONA/2. FEBRERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_HECTOR_ROIG_NADAL.pdf\u0027 },\n\n  // ADMINISTRADOR DE FINCAS - MADRID\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/MADRID/2. FEBRERO/1a SEMANA/CITADOS`, name: \u0027CV_TERESA_MOYA_SEGURA.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/MADRID/2. FEBRERO/1a SEMANA/DESCARTADOS`, name: \u0027CV_RUBEN_PRATS_OLIVE.pdf\u0027 },\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // FEBRERO - 2a SEMANA (9-14 feb) â† SEMANA ACTUAL\n  // Incluye PENDIENTES (CVs recien llegados sin clasificar)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // ASESOR COMERCIAL - BARCELONA\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_PEPE_GARCIA_NAVARRO.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_ANA_MARTINEZ_RUIZ.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_JORDI_BLANCH_SEGUI.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA/CITADOS`, name: \u0027CV_MARIA_FERNANDEZ_GIL.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_JUAN_PEREZ_BLANCO.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/BARCELONA/2. FEBRERO/2a SEMANA/CITAS FUERA JORNADA`, name: \u0027CV_ROSA_GOMEZ_TORRES.pdf\u0027 },\n\n  // ASESOR COMERCIAL - VALENCIA\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/2. FEBRERO/2a SEMANA`, name: \u0027CV_CARLOS_LOPEZ_DIAZ.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/VALENCIA/2. FEBRERO/2a SEMANA/CITADOS`, name: \u0027CV_LAURA_SANCHEZ_VEGA.pdf\u0027 },\n\n  // ASESOR COMERCIAL - MADRID\n  { path: `${basePath}/ASESOR COMERCIAL/MADRID/2. FEBRERO/2a SEMANA`, name: \u0027CV_ALVARO_REYES_NIETO.pdf\u0027 },\n  { path: `${basePath}/ASESOR COMERCIAL/MADRID/2. FEBRERO/2a SEMANA/CITADOS`, name: \u0027CV_BEATRIZ_ROMERO_SANZ.pdf\u0027 },\n\n  // FINANZATE - BARCELONA\n  { path: `${basePath}/FINANZATE/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_PABLO_RUIZ_MORENO.pdf\u0027 },\n  { path: `${basePath}/FINANZATE/BARCELONA/2. FEBRERO/2a SEMANA/CITADOS`, name: \u0027CV_ELENA_DIAZ_CASTRO.pdf\u0027 },\n  { path: `${basePath}/FINANZATE/BARCELONA/2. FEBRERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_SERGIO_MOLINA_ROCA.pdf\u0027 },\n\n  // ADMINISTRADOR DE FINCAS - BARCELONA\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_MARTA_JIMENEZ_PRAT.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/2. FEBRERO/2a SEMANA`, name: \u0027CV_DAVID_SOLER_FONT.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/2. FEBRERO/2a SEMANA/CITADOS`, name: \u0027CV_NURIA_VIDAL_SERRA.pdf\u0027 },\n  { path: `${basePath}/ADMINISTRADOR DE FINCAS/BARCELONA/2. FEBRERO/2a SEMANA/DESCARTADOS`, name: \u0027CV_ALEX_PUIG_COSTA.pdf\u0027 }\n];\n\nreturn [{ json: { pdfs, totalPdfs: pdfs.length } }];"},"id":"1bf13be4-be45-4118-a484-58f0a362ef93","name":"Definir Estructura v2","type":"n8n-nodes-base.code","typeVersion":2,"position":[-10544,4080]},{"parameters":{"jsCode":"const { pdfs } = $input.first().json;\nreturn pdfs.map(p =\u003e ({ json: { ...p } }));"},"id":"085b8ae0-21c5-4b11-9b43-9be35a3e8343","name":"Split PDFs","type":"n8n-nodes-base.code","typeVersion":2,"position":[-10320,4080]},{"parameters":{"method":"PUT","url":"=https://graph.microsoft.com/v1.0/me/drive/root:/{{ encodeURI($json.path + \u0027/\u0027 + $json.name) }}:/content","authentication":"predefinedCredentialType","nodeCredentialType":"microsoftOneDriveOAuth2Api","sendBody":true,"contentType":"raw","rawContentType":"application/pdf","body":"CV Demo - Candidato de prueba para workflow RRHH La Casa Agency","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"ec86755f-6fca-4039-a837-eaf169fcb9e2","name":"Subir PDFs Demo","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-10096,4080],"credentials":{"microsoftOneDriveOAuth2Api":{"id":"OF2rMJ4ZrCjjkJwn","name":"Microsoft Drive account"}},"onError":"continueRegularOutput","notes":"PUT /content crea archivo + todas las carpetas padre automaticamente"},{"parameters":{"jsCode":"// Resumen de archivos subidos\nconst uploaded = $input.all();\nconst total = $(\u0027Definir Estructura\u0027).first().json.totalPdfs;\n\nconst exitosos = uploaded.filter(i =\u003e i.json.id);\nconst errores = uploaded.filter(i =\u003e !i.json.id);\n\n// Contar por estado\nconst estados = { PENDIENTE: 0, CITADO: 0, DESCARTADO: 0, CITA_FUERA_JORNADA: 0 };\nfor (const item of exitosos) {\n  const path = item.json.parentReference?.path || \u0027\u0027;\n  if (path.includes(\u0027CITADOS\u0027)) estados.CITADO++;\n  else if (path.includes(\u0027DESCARTADOS\u0027)) estados.DESCARTADO++;\n  else if (path.includes(\u0027CITAS FUERA JORNADA\u0027)) estados.CITA_FUERA_JORNADA++;\n  else estados.PENDIENTE++;\n}\n\nreturn [{\n  json: {\n    \u0027=== SETUP COMPLETADO ===\u0027: \u002713 febrero 2026\u0027,\n    esperados: total,\n    subidos_ok: exitosos.length,\n    errores: errores.length,\n    distribucion_estados: estados,\n    posiciones: [\u0027ASESOR COMERCIAL\u0027, \u0027FINANZATE\u0027, \u0027ADMINISTRADOR DE FINCAS\u0027],\n    ciudades: [\u0027BARCELONA\u0027, \u0027VALENCIA\u0027, \u0027MADRID\u0027],\n    periodos: [\n      \u00271. ENERO / 1a-4a SEMANA (semanas cerradas)\u0027,\n      \u00272. FEBRERO / 1a SEMANA (semana cerrada)\u0027,\n      \u00272. FEBRERO / 2a SEMANA (semana actual con PENDIENTES)\u0027\n    ],\n    nota: \u0027Espera 2-3 min para que el indice de busqueda se actualice antes de ejecutar WF1\u0027\n  }\n}];"},"id":"8752f610-a3b1-469c-a71f-689605d63c5b","name":"Resumen","type":"n8n-nodes-base.code","typeVersion":2,"position":[-9872,4080]},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":3}]}},"id":"18eb5c6a-07ee-4d27-985e-4d2e0c35182d","name":"Cron 3min","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-10768,4752]},{"parameters":{"url":"https://graph.microsoft.com/v1.0/me/drive/root:/Base de datos/2026:/search(q=\u0027.pdf\u0027)?$top=200\u0026$select=id,name,size,lastModifiedDateTime,webUrl,parentReference,file","authentication":"predefinedCredentialType","nodeCredentialType":"microsoftOneDriveOAuth2Api","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"7199d202-9251-4e05-ac99-1095347ccbf2","name":"1. Buscar PDFs OneDrive","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-10544,4752],"credentials":{"microsoftOneDriveOAuth2Api":{"id":"OF2rMJ4ZrCjjkJwn","name":"Microsoft Drive account"}},"notes":"OneDrive Personal: /me/drive/\nPara SharePoint: /sites/{siteId}/drives/{driveId}/root:/...\n$top=200 para paginacion. Si hay mas, usar @odata.nextLink"},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Parsear TODOS los PDFs y devolver UN SOLO item con array\n// Esto permite leer la Sheet 1 sola vez\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst response = $input.first().json;\nconst files = response.value || [];\n\nconst ESTADO_MAP = {\n  \u0027CITADOS\u0027: \u0027CITADO\u0027,\n  \u0027DESCARTADOS\u0027: \u0027DESCARTADO\u0027,\n  \u0027CITAS FUERA JORNADA\u0027: \u0027CITA_FUERA_JORNADA\u0027\n};\n\nfunction normalizeName(str) {\n  return (str || \u0027\u0027)\n    .normalize(\u0027NFD\u0027).replace(/[\\u0300-\\u036f]/g, \u0027\u0027)\n    .toLowerCase()\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n}\n\nconst pdfs = [];\n\nfor (const file of files) {\n  if (!file.name || !file.name.toLowerCase().endsWith(\u0027.pdf\u0027)) continue;\n  \n  const parentPath = file.parentReference?.path || \u0027\u0027;\n  const fullPath = parentPath + \u0027/\u0027 + file.name;\n  \n  const afterBase = parentPath.split(\u0027/2026/\u0027);\n  if (afterBase.length \u003c 2) continue;\n  \n  const pathParts = afterBase[1].split(\u0027/\u0027);\n  if (pathParts.length \u003c 4) continue;\n  \n  const posicion = pathParts[0] || \u0027\u0027;\n  const ciudad = pathParts[1] || \u0027\u0027;\n  const mes = pathParts[2] || \u0027\u0027;\n  const semana = pathParts[3] || \u0027\u0027;\n  const subcarpeta = pathParts[4] || \u0027\u0027;\n  \n  let estado = \u0027PENDIENTE\u0027;\n  for (const [carpeta, est] of Object.entries(ESTADO_MAP)) {\n    if (subcarpeta.toUpperCase().includes(carpeta.toUpperCase())) {\n      estado = est;\n      break;\n    }\n  }\n  \n  let nombreArchivo = file.name\n    .replace(/\\.pdf$/i, \u0027\u0027)\n    .replace(/^CV[_\\s-]*/i, \u0027\u0027)\n    .replace(/[_-]/g, \u0027 \u0027)\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n  \n  const nombreFormateado = nombreArchivo\n    .replace(/\\b\\w/g, c =\u003e c.toUpperCase());\n  \n  pdfs.push({\n    fileId: file.id,\n    fileName: file.name,\n    filePath: fullPath,\n    fileSize: file.size,\n    lastModified: file.lastModifiedDateTime,\n    webUrl: file.webUrl || \u0027\u0027,\n    posicion, ciudad, mes, semana, subcarpeta, estado,\n    nombreArchivo: nombreFormateado,\n    nombreNormalizado: normalizeName(nombreFormateado)\n  });\n}\n\n// Devolver UN SOLO item con el array de PDFs\nreturn [{ json: { pdfs, totalPdfs: pdfs.length, empty: pdfs.length === 0 } }];"},"id":"32c5ff61-a52b-45e8-a606-6208c4867c3a","name":"2. Parsear Rutas","type":"n8n-nodes-base.code","typeVersion":2,"position":[-10320,4752]},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"c1","leftValue":"={{ $json.totalPdfs }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"4a05fabf-be68-4997-a73d-e2efcfaeec0c","name":"Hay archivos?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-10096,4752]},{"parameters":{"operation":"getAll","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"}},"id":"d6d7f1fc-1ef4-43a4-91d4-b2a580a79ba2","name":"3. Leer Sheet COMPLETA","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-9872,4752],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}},"onError":"continueRegularOutput","notes":"Lee TODA la sheet de una sola vez para evitar multiples llamadas API"},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// COMPARAR PDFs vs Sheet - BIDIRECCIONAL\n// Detecta cambios en OneDrive Y en la Sheet\n// Usa _ultimo_sync para saber quien cambio\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction norm(str) {\n  return (str || \u0027\u0027)\n    .normalize(\u0027NFD\u0027).replace(/[\\u0300-\\u036f]/g, \u0027\u0027)\n    .toLowerCase()\n    .replace(/\\s+/g, \u0027 \u0027)\n    .trim();\n}\n\nconst sheetRows = $(\u00273. Leer Sheet COMPLETA\u0027).all().map(i =\u003e i.json);\n\n// Indices\nconst sheetByName = {};\nfor (let i = 0; i \u003c sheetRows.length; i++) {\n  const row = sheetRows[i];\n  const key = norm(row.NOMBRE || \u0027\u0027);\n  if (key \u0026\u0026 !sheetByName[key]) {\n    sheetByName[key] = { ...row, _rowIndex: i + 2 };\n  }\n}\n\nconst pdfs = $(\u00272. Parsear Rutas\u0027).first().json.pdfs || [];\nconst results = [];\nlet stats = { insertar: 0, actualizar_sheet: 0, mover_onedrive: 0, skip: 0 };\n\nfor (const pdf of pdfs) {\n  const match = sheetByName[pdf.nombreNormalizado] || null;\n  \n  if (!match) {\n    // Nuevo: no existe en Sheet â†’ INSERTAR\n    results.push({ json: { ...pdf, accion: \u0027INSERTAR\u0027 }});\n    stats.insertar++;\n    continue;\n  }\n  \n  const sheetEstado = norm(match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027);\n  const onedriveEstado = norm(pdf.estado);\n  const ultimoSync = norm(match._ultimo_sync || \u0027\u0027);\n  \n  if (sheetEstado === onedriveEstado) {\n    // Sincronizados â†’ SKIP\n    stats.skip++;\n    continue;\n  }\n  \n  // HAY DIFERENCIA: determinar quien cambio\n  if (!ultimoSync || ultimoSync === sheetEstado) {\n    // _ultimo_sync coincide con Sheet (o no existe) â†’ OneDrive cambio\n    // Accion: actualizar Sheet para reflejar OneDrive\n    results.push({ json: {\n      ...pdf,\n      accion: \u0027ACTUALIZAR_SHEET\u0027,\n      situacionAnterior: match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027,\n      matchNombre: match.NOMBRE,\n      matchRowIndex: match._rowIndex\n    }});\n    stats.actualizar_sheet++;\n  } else if (ultimoSync === onedriveEstado) {\n    // _ultimo_sync coincide con OneDrive â†’ Sheet cambio\n    // Accion: mover archivo en OneDrive para reflejar Sheet\n    const nuevoEstado = (match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027).trim();\n    results.push({ json: {\n      ...pdf,\n      accion: \u0027MOVER_ONEDRIVE\u0027,\n      nuevoEstado: nuevoEstado,\n      situacionAnterior: pdf.estado,\n      matchNombre: match.NOMBRE,\n      matchRowIndex: match._rowIndex\n    }});\n    stats.mover_onedrive++;\n  } else {\n    // Conflicto: ambos cambiaron. Sheet gana (es donde trabajan los usuarios)\n    const nuevoEstado = (match[\u0027SITUACIÃ“N\u0027] || match[\u0027SITUACION\u0027] || \u0027\u0027).trim();\n    results.push({ json: {\n      ...pdf,\n      accion: \u0027MOVER_ONEDRIVE\u0027,\n      nuevoEstado: nuevoEstado,\n      situacionAnterior: pdf.estado,\n      matchNombre: match.NOMBRE,\n      matchRowIndex: match._rowIndex,\n      _conflicto: true\n    }});\n    stats.mover_onedrive++;\n  }\n}\n\nif (results.length === 0) {\n  return [{ json: { accion: \u0027NINGUNA\u0027, _skip: true, _resumen: JSON.stringify(stats) }}];\n}\n\nresults[0].json._resumen = JSON.stringify(stats);\nreturn results;"},"id":"1f8843e5-0053-415b-b830-3aeac018dde5","name":"4. Comparar PDF vs Sheet","type":"n8n-nodes-base.code","typeVersion":2,"position":[-9648,4752]},{"parameters":{"rules":{"values":[{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"INSERTAR","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"NUEVO"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"ACTUALIZAR_SHEET","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"ACTUALIZAR_SHEET"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"MOVER_ONEDRIVE","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"MOVER_ONEDRIVE"},{"conditions":{"conditions":[{"leftValue":"={{ $json.accion }}","rightValue":"NINGUNA","operator":{"type":"string","operation":"equals"}}]},"renameOutput":true,"outputKey":"SKIP"}]},"options":{}},"id":"07cb0b11-7608-4451-8a08-29cd916f3bd9","name":"5. Switch Accion","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-9424,4720]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":1135598434,"mode":"list","cachedResultName":"BASE DE DATOS 2026 BCN","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM/edit#gid=1135598434"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"MES","displayName":"MES","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"NOMBRE","displayName":"NOMBRE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FORMATO","displayName":"FORMATO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"OFICINA","displayName":"OFICINA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":" RESIDENCIA","displayName":" RESIDENCIA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FECHA","displayName":"FECHA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"HORA","displayName":"HORA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CORREO","displayName":"CORREO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"TELÃ‰FONO","displayName":"TELÃ‰FONO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FUENTE","displayName":"FUENTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CONFIRMACIÃ“N","displayName":"CONFIRMACIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CITADO POR","displayName":"CITADO POR","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ASISTENCIA","displayName":"ASISTENCIA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ENTREVISTADO POR","displayName":"ENTREVISTADO POR","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MOTIVO DESCARTE","displayName":"MOTIVO DESCARTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MAIL DESCARTE","displayName":"MAIL DESCARTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"COMENTARIOS","displayName":"COMENTARIOS","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"SITUACIÃ“N","displayName":"SITUACIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"POSICIÃ“N","displayName":"POSICIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"INICIO","displayName":"INICIO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FIN","displayName":"FIN","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CAUSA","displayName":"CAUSA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_accion","displayName":"_accion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_fileId","displayName":"_fileId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_fileName","displayName":"_fileName","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false,"ignoreAdditionalFields":true},"options":{"cellFormat":"USER_ENTERED"}},"id":"f04e9485-f25f-45d9-8573-cb0160c5e8bc","name":"7a. Insertar en Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-8976,4752],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"jsCode":"// Preparar actualizacion de SITUACION + _ultimo_sync\nconst item = $input.first().json;\n\nreturn [{ json: {\n  NOMBRE: item.matchNombre || item.nombreArchivo,\n  \u0027SITUACIÃ“N\u0027: item.estado,\n  _ultimo_sync: item.estado,\n  _accion: \u0027ACTUALIZAR_SHEET\u0027,\n  _situacionAnterior: item.situacionAnterior,\n  _fileName: item.fileName\n} }];"},"id":"da233fe7-5201-41e4-b432-f70934b4d0f4","name":"6e. Preparar Actualizacion","type":"n8n-nodes-base.code","typeVersion":2,"position":[-9200,4944]},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":1135598434,"mode":"list","cachedResultName":"BASE DE DATOS 2026 BCN","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM/edit#gid=1135598434"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"MES","displayName":"MES","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"NOMBRE","displayName":"NOMBRE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FORMATO","displayName":"FORMATO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"OFICINA","displayName":"OFICINA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":" RESIDENCIA","displayName":" RESIDENCIA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FECHA","displayName":"FECHA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"HORA","displayName":"HORA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CORREO","displayName":"CORREO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"TELÃ‰FONO","displayName":"TELÃ‰FONO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FUENTE","displayName":"FUENTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CONFIRMACIÃ“N","displayName":"CONFIRMACIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CITADO POR","displayName":"CITADO POR","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ASISTENCIA","displayName":"ASISTENCIA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ENTREVISTADO POR","displayName":"ENTREVISTADO POR","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MOTIVO DESCARTE","displayName":"MOTIVO DESCARTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MAIL DESCARTE","displayName":"MAIL DESCARTE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"COMENTARIOS","displayName":"COMENTARIOS","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"SITUACIÃ“N","displayName":"SITUACIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"POSICIÃ“N","displayName":"POSICIÃ“N","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"INICIO","displayName":"INICIO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FIN","displayName":"FIN","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CAUSA","displayName":"CAUSA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_accion","displayName":"_accion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_fileId","displayName":"_fileId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"_fileName","displayName":"_fileName","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false,"ignoreAdditionalFields":true},"options":{"cellFormat":"USER_ENTERED"}},"id":"b90ec0af-e4e6-46f7-84ca-c5c2c6488e73","name":"7b. Actualizar en Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-8976,4944],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":"Log","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"timestamp":"={{ $now.toISO() }}","nombre":"={{ $json.NOMBRE }}","accion":"={{ $json._accion }}","situacion_anterior":"={{ $json._situacionAnterior || \u0027N/A\u0027 }}","situacion_nueva":"={{ $json[\u0027SITUACIÃ“N\u0027] || $json.estado }}","posicion":"={{ $json[\u0027POSICIÃ“N\u0027] || $json.posicion || \u0027\u0027 }}","archivo":"={{ $json._fileName || \u0027\u0027 }}"},"matchingColumns":[],"schema":[{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nombre","displayName":"nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"accion","displayName":"accion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"situacion_anterior","displayName":"situacion_anterior","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"situacion_nueva","displayName":"situacion_nueva","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"posicion","displayName":"posicion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"archivo","displayName":"archivo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"cellFormat":"USER_ENTERED"}},"id":"23c44cb8-c53b-4e44-af90-fb8710fb6c9f","name":"8. Log Cambio","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-8752,4752],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"c2","leftValue":"={{ $json[\u0027SITUACIÃ“N\u0027] || $json.estado }}","rightValue":"CITADO","operator":{"type":"string","operation":"equals"}},{"id":"c3","leftValue":"={{ $json._accion }}","rightValue":"INSERTAR","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"id":"c52a97c4-83a3-4015-9109-bdd6f89f3627","name":"9. Es citado nuevo?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-8528,4752],"notes":"Lanza WF2 si:\n- Estado es CITADO (cambio de carpeta)\n- O es un insert nuevo con estado CITADO\nEvita lanzar WF2 para candidatos ya procesados"},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO UNIFICADO: Descargar PDF + Extraer IA + Preparar fila\n// Un solo Code node para evitar paired item issues de n8n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst rutaData = $input.first().json;\nconst API_KEY = \u0027CONFIGURAR_OPENAI_API_KEY\u0027; // â† CAMBIAR POR TU API KEY\n\n// --- 1. Descargar PDF de OneDrive ---\nlet pdfBase64 = \u0027\u0027;\ntry {\n  const downloadResp = await this.helpers.requestWithAuthentication.call(\n    this, \u0027microsoftOneDriveOAuth2Api\u0027, {\n      method: \u0027GET\u0027,\n      uri: \u0027https://graph.microsoft.com/v1.0/me/drive/items/\u0027 + rutaData.fileId + \u0027/content\u0027,\n      encoding: null,\n      resolveWithFullResponse: true\n    }\n  );\n  pdfBase64 = Buffer.from(downloadResp.body).toString(\u0027base64\u0027);\n} catch (e) {\n  // Si falla la descarga, continuamos solo con el nombre del archivo\n  console.log(\u0027Download failed:\u0027, e.message);\n}\n\n// --- 2. Llamar GPT-4o via OpenAI ---\nlet cv = {};\ntry {\n  const userContent = pdfBase64\n    ? [\n        { type: \u0027file\u0027, file: { filename: rutaData.fileName, file_data: \u0027data:application/pdf;base64,\u0027 + pdfBase64 } },\n        { type: \u0027text\u0027, text: \u0027Extrae los datos de este CV de InfoJobs.\u0027 }\n      ]\n    : \u0027Extrae los datos de este CV basandote en el nombre del archivo: \u0027 + rutaData.fileName + \u0027. Solo tienes el nombre del archivo, extrae lo que puedas.\u0027;\n\n  const aiResp = await this.helpers.httpRequest({\n    method: \u0027POST\u0027,\n    url: \u0027https://api.openai.com/v1/chat/completions\u0027,\n    headers: { \u0027Authorization\u0027: \u0027Bearer \u0027 + API_KEY, \u0027Content-Type\u0027: \u0027application/json\u0027 },\n    body: {\n      model: \u0027gpt-4o\u0027,\n      messages: [\n        {\n          role: \u0027system\u0027,\n          content: `Eres un extractor de datos de CVs de InfoJobs para una empresa inmobiliaria. Extrae los datos del candidato y responde UNICAMENTE con JSON valido (sin markdown, sin backticks). Campos:\n{\n  \"nombre_completo\": \"Nombre y apellidos exactos\",\n  \"email\": \"email o vacio\",\n  \"telefono\": \"telefono con prefijo o vacio\",\n  \"residencia\": \"ciudad o barrio de residencia o vacio\",\n  \"edad\": \"numero o vacio\",\n  \"experiencia_resumen\": \"max 50 palabras\",\n  \"formacion\": \"nivel formativo principal\",\n  \"disponibilidad\": \"inmediata/parcial/especificar o vacio\",\n  \"idiomas\": \"lista de idiomas o vacio\",\n  \"carnet_conducir\": \"si/no/vacio\",\n  \"vehiculo_propio\": \"si/no/vacio\"\n}\nReglas: Si un dato no aparece, pon string vacio. NUNCA inventes datos. SOLO JSON.`\n        },\n        { role: \u0027user\u0027, content: userContent }\n      ],\n      max_tokens: 600,\n      temperature: 0\n    },\n    json: true,\n    timeout: 30000\n  });\n\n  const raw = aiResp.choices?.[0]?.message?.content || \u0027{}\u0027;\n  cv = JSON.parse(raw.replace(/```json\\n?/g, \u0027\u0027).replace(/```\\n?/g, \u0027\u0027).trim());\n} catch (e) {\n  console.log(\u0027AI extraction failed:\u0027, e.message);\n  cv = { nombre_completo: rutaData.nombreArchivo || \u0027\u0027 };\n}\n\n// --- 3. Preparar fila para Google Sheet ---\nconst mesMap = {\n  \u00271. ENERO\u0027: \u0027Enero\u0027, \u00272. FEBRERO\u0027: \u0027Febrero\u0027, \u00273. MARZO\u0027: \u0027Marzo\u0027,\n  \u00274. ABRIL\u0027: \u0027Abril\u0027, \u00275. MAYO\u0027: \u0027Mayo\u0027, \u00276. JUNIO\u0027: \u0027Junio\u0027,\n  \u00277. JULIO\u0027: \u0027Julio\u0027, \u00278. AGOSTO\u0027: \u0027Agosto\u0027, \u00279. SEPTIEMBRE\u0027: \u0027Septiembre\u0027,\n  \u002710. OCTUBRE\u0027: \u0027Octubre\u0027, \u002711. NOVIEMBRE\u0027: \u0027Noviembre\u0027, \u002712. DICIEMBRE\u0027: \u0027Diciembre\u0027\n};\n\nconst nombre = (cv.nombre_completo \u0026\u0026 cv.nombre_completo.length \u003e 3)\n  ? cv.nombre_completo\n  : (rutaData.nombreArchivo || \u0027Desconocido\u0027);\n\nreturn [{\n  json: {\n    MES: mesMap[rutaData.mes] || rutaData.mes || \u0027\u0027,\n    NOMBRE: nombre,\n    FORMATO: \u0027\u0027,\n    OFICINA: rutaData.ciudad || \u0027\u0027,\n    \u0027 RESIDENCIA\u0027: cv.residencia || \u0027\u0027,\n    FECHA: new Date().toLocaleDateString(\u0027es-ES\u0027),\n    HORA: \u0027\u0027,\n    CORREO: cv.email || \u0027\u0027,\n    \u0027TELÃ‰FONO\u0027: cv.telefono || \u0027\u0027,\n    FUENTE: \u0027InfoJobs\u0027,\n    \u0027CONFIRMACIÃ“N\u0027: \u0027\u0027,\n    \u0027CITADO POR\u0027: \u0027\u0027,\n    ASISTENCIA: \u0027\u0027,\n    \u0027ENTREVISTADO POR\u0027: \u0027\u0027,\n    \u0027MOTIVO DESCARTE\u0027: \u0027\u0027,\n    \u0027MAIL DESCARTE\u0027: \u0027\u0027,\n    COMENTARIOS: [\n      cv.experiencia_resumen ? \u0027Exp: \u0027 + cv.experiencia_resumen : \u0027\u0027,\n      cv.formacion ? \u0027Form: \u0027 + cv.formacion : \u0027\u0027,\n      cv.idiomas ? \u0027Idiomas: \u0027 + cv.idiomas : \u0027\u0027,\n      cv.edad ? \u0027Edad: \u0027 + cv.edad : \u0027\u0027,\n      cv.carnet_conducir === \u0027si\u0027 ? \u0027Carnet: Si\u0027 : \u0027\u0027,\n      cv.vehiculo_propio === \u0027si\u0027 ? \u0027Vehiculo: Si\u0027 : \u0027\u0027\n    ].filter(Boolean).join(\u0027 | \u0027),\n    \u0027SITUACIÃ“N\u0027: rutaData.estado || \u0027\u0027,\n    \u0027POSICIÃ“N\u0027: rutaData.posicion || \u0027\u0027,\n    INICIO: \u0027\u0027,\n    FIN: \u0027\u0027,\n    CAUSA: \u0027\u0027,\n    _accion: \u0027INSERTAR\u0027,\n    _ultimo_sync: rutaData.estado || \u0027\u0027,\n    _fileId: rutaData.fileId || \u0027\u0027,\n    _fileName: rutaData.fileName || \u0027\u0027\n  }\n}];"},"id":"590fe372-16f2-4f10-a966-2aa3ed177b77","name":"6. Descargar + IA + Preparar","type":"n8n-nodes-base.code","typeVersion":2,"position":[-9200,4752],"notes":"Nodo unificado: descarga PDF + GPT-4o + prepara fila.\nCONFIGURAR: cambiar CONFIGURAR_OPENAI_API_KEY por tu API key real."},{"parameters":{"jsCode":"// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MOVER ARCHIVO EN ONEDRIVE\n// Cuando la Sheet cambia SITUACION, mover el PDF a la carpeta correcta\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst item = $input.first().json;\n\n// Mapear estado a nombre de subcarpeta en OneDrive\nconst CARPETA_MAP = {\n  \u0027CITADO\u0027: \u0027CITADOS\u0027,\n  \u0027DESCARTADO\u0027: \u0027DESCARTADOS\u0027,\n  \u0027CITA_FUERA_JORNADA\u0027: \u0027CITAS FUERA JORNADA\u0027,\n  \u0027PENDIENTE\u0027: \u0027\u0027 // raiz de la semana\n};\n\nconst nuevoEstado = (item.nuevoEstado || \u0027\u0027).toUpperCase().trim();\n\n// Normalizar estado\nlet estadoNorm = nuevoEstado;\nif (nuevoEstado.includes(\u0027CITADO\u0027) \u0026\u0026 !nuevoEstado.includes(\u0027DESCARTADO\u0027) \u0026\u0026 !nuevoEstado.includes(\u0027FUERA\u0027)) {\n  estadoNorm = \u0027CITADO\u0027;\n} else if (nuevoEstado.includes(\u0027DESCARTADO\u0027) || nuevoEstado.includes(\u0027DESCARTE\u0027)) {\n  estadoNorm = \u0027DESCARTADO\u0027;\n} else if (nuevoEstado.includes(\u0027FUERA\u0027) || nuevoEstado.includes(\u0027CITA_FUERA\u0027)) {\n  estadoNorm = \u0027CITA_FUERA_JORNADA\u0027;\n} else {\n  estadoNorm = \u0027PENDIENTE\u0027;\n}\n\nconst subcarpeta = CARPETA_MAP[estadoNorm] || \u0027\u0027;\n\n// Construir nueva ruta destino\n// Formato: /drive/root:/Base de datos/2026/POSICION/CIUDAD/MES/SEMANA/[SUBCARPETA]\nconst basePath = \u0027/drive/root:/Base de datos/2026/\u0027 + item.posicion + \u0027/\u0027 + item.ciudad + \u0027/\u0027 + item.mes + \u0027/\u0027 + item.semana;\nconst destPath = subcarpeta ? basePath + \u0027/\u0027 + subcarpeta : basePath;\n\n// Mover archivo via Graph API\ntry {\n  const moveResp = await this.helpers.requestWithAuthentication.call(\n    this, \u0027microsoftOneDriveOAuth2Api\u0027, {\n      method: \u0027PATCH\u0027,\n      uri: \u0027https://graph.microsoft.com/v1.0/me/drive/items/\u0027 + item.fileId,\n      headers: { \u0027Content-Type\u0027: \u0027application/json\u0027 },\n      body: JSON.stringify({\n        parentReference: {\n          path: destPath\n        }\n      })\n    }\n  );\n  \n  return [{ json: {\n    NOMBRE: item.matchNombre || item.nombreArchivo,\n    _ultimo_sync: estadoNorm,\n    _accion: \u0027MOVER_ONEDRIVE\u0027,\n    _situacionAnterior: item.estado,\n    _situacionNueva: estadoNorm,\n    _fileName: item.fileName,\n    _destino: destPath,\n    _movido: true\n  }}];\n} catch (e) {\n  return [{ json: {\n    NOMBRE: item.matchNombre || item.nombreArchivo,\n    _accion: \u0027MOVER_ONEDRIVE\u0027,\n    _error: e.message,\n    _fileName: item.fileName,\n    _destino: destPath,\n    _movido: false\n  }}];\n}"},"id":"af0f00ef-56ad-45d9-9bf7-a0b057ec6206","name":"6f. Mover en OneDrive","type":"n8n-nodes-base.code","typeVersion":2,"position":[-9200,4560],"notes":"Mueve el PDF a la carpeta correcta segun el estado de la Sheet.\nCITADOâ†’CITADOS, DESCARTADOâ†’DESCARTADOS, etc."},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM","mode":"id"},"sheetName":{"__rl":true,"value":1135598434,"mode":"list","cachedResultName":"BASE DE DATOS 2026 BCN","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1vGipz1b6gNlAbLlCD7EQS5_GoSEWiQaHa4U1TKNRLiM/edit#gid=1135598434"},"columns":{"mappingMode":"defineBelow","value":{"NOMBRE":"={{ $json.NOMBRE }}","_ultimo_sync":"={{ $json._ultimo_sync }}"},"matchingColumns":["NOMBRE"]},"options":{"cellFormat":"USER_ENTERED"}},"id":"ebf7e3fd-cd9d-4f27-a67e-92d6c629d6ae","name":"7c. Sync _ultimo_sync","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-8976,4560],"credentials":{"googleSheetsOAuth2Api":{"id":"xDl2hOMI5H0CipOz","name":"programacion@conexiatec.com"}}}],"connections":{"Ejecutar Manual":{"main":[[{"node":"Definir Estructura v2","type":"main","index":0}]]},"Definir Estructura v2":{"main":[[{"node":"Split PDFs","type":"main","index":0}]]},"Split PDFs":{"main":[[{"node":"Subir PDFs Demo","type":"main","index":0}]]},"Subir PDFs Demo":{"main":[[{"node":"Resumen","type":"main","index":0}]]},"Cron 3min":{"main":[[{"node":"1. Buscar PDFs OneDrive","type":"main","index":0}]]},"1. Buscar PDFs OneDrive":{"main":[[{"node":"2. Parsear Rutas","type":"main","index":0}]]},"2. Parsear Rutas":{"main":[[{"node":"Hay archivos?","type":"main","index":0}]]},"Hay archivos?":{"main":[[{"node":"3. Leer Sheet COMPLETA","type":"main","index":0}]]},"3. Leer Sheet COMPLETA":{"main":[[{"node":"4. Comparar PDF vs Sheet","type":"main","index":0}]]},"4. Comparar PDF vs Sheet":{"main":[[{"node":"5. Switch Accion","type":"main","index":0}]]},"5. Switch Accion":{"main":[[{"node":"6. Descargar + IA + Preparar","type":"main","index":0}],[{"node":"6e. Preparar Actualizacion","type":"main","index":0}],[{"node":"6f. Mover en OneDrive","type":"main","index":0}]]},"7a. Insertar en Sheet":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]},"6e. Preparar Actualizacion":{"main":[[{"node":"7b. Actualizar en Sheet","type":"main","index":0}]]},"7b. Actualizar en Sheet":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]},"8. Log Cambio":{"main":[[{"node":"9. Es citado nuevo?","type":"main","index":0}]]},"9. Es citado nuevo?":{"main":[[]]},"6. Descargar + IA + Preparar":{"main":[[{"node":"7a. Insertar en Sheet","type":"main","index":0}]]},"6f. Mover en OneDrive":{"main":[[{"node":"7c. Sync _ultimo_sync","type":"main","index":0}]]},"7c. Sync _ultimo_sync":{"main":[[{"node":"8. Log Cambio","type":"main","index":0}]]}},"authors":"Ivan Madrid","name":"Version 1bfec2ae","description":"","autosaved":true,"workflowPublishHistory":[{"createdAt":"2026-02-13T12:35:43.137Z","id":203,"workflowId":"7ELtvdYY0xq2eOU4","versionId":"1bfec2ae-f3b7-4a76-84fc-f109916aa60d","event":"activated","userId":"0dadf7b3-164c-4595-8178-913217f7f722"}]}}