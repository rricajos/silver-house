name: Deploy n8n Workflows

on:
  push:
    branches:
      - main
    paths:
      - 'workflows/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed workflow files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: deploy all workflows listed in mapping.json
            CHANGED=$(jq -r 'keys[]' workflows/mapping.json | sed 's|^|workflows/|')
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'workflows/*.json' | grep -v 'workflows/mapping.json' || true)
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy changed workflows to n8n
        if: steps.changed.outputs.files != ''
        env:
          N8N_URL: ${{ secrets.N8N_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          MAPPING=$(cat workflows/mapping.json)

          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue

            FILENAME=$(basename "$FILE")
            WORKFLOW_ID=$(echo "$MAPPING" | jq -r --arg f "$FILENAME" '.[$f] // ""')

            if [ -z "$WORKFLOW_ID" ]; then
              echo "‚ö†Ô∏è  No mapping found for $FILENAME, skipping."
              continue
            fi

            echo "üì§ Updating workflow '$FILENAME' (ID: $WORKFLOW_ID)..."

            # Strip fields not accepted by n8n PUT API ‚Äî only name, nodes, connections, settings, staticData are allowed
            jq '{name, nodes, connections, settings, staticData}' "$FILE" > /tmp/payload.json

            HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              -X PUT "$N8N_URL/api/v1/workflows/$WORKFLOW_ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              -d @/tmp/payload.json)

            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "‚úÖ Successfully updated $FILENAME (HTTP $HTTP_STATUS)"
            else
              echo "‚ùå Failed to update $FILENAME (HTTP $HTTP_STATUS)"
              cat /tmp/response.json
              exit 1
            fi
          done <<< "${{ steps.changed.outputs.files }}"

      - name: No workflow changes detected
        if: steps.changed.outputs.files == ''
        run: echo "‚ÑπÔ∏è  No workflow files changed, nothing to deploy."
