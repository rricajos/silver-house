name: Deploy n8n Workflows

on:
  push:
    branches:
      - main
    paths:
      - 'workflows/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

# Prevent concurrent deploys ‚Äî never cancel in progress, queue instead
concurrency:
  group: n8n-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history needed for reliable before/after diff

      - name: Detect changed workflow files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: deploy all workflows listed in mapping.json
            CHANGED=$(jq -r 'keys[]' workflows/mapping.json | sed 's|^|workflows/|')
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            # First push to branch has before = 0000...0000, diff against empty tree
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              CHANGED=$(git diff --name-only 4b825dc642cb6eb9a060e54bf8d69288fbee4904 "$AFTER" -- 'workflows/*.json' | grep -v 'workflows/mapping.json' || true)
            else
              CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" -- 'workflows/*.json' | grep -v 'workflows/mapping.json' || true)
            fi
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy changed workflows to n8n
        if: steps.changed.outputs.files != ''
        env:
          N8N_URL: ${{ secrets.N8N_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          echo "::notice::DEPLOY_START files=${{ steps.changed.outputs.files }}"
          MAPPING=$(cat workflows/mapping.json)
          SUMMARY=""

          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            echo "::notice::LOOP_FILE=$FILE"

            FILENAME=$(basename "$FILE")
            WORKFLOW_ID=$(echo "$MAPPING" | jq -r --arg f "$FILENAME" '.[$f] // ""')
            echo "::notice::WORKFLOW_ID=$WORKFLOW_ID"

            if [ -z "$WORKFLOW_ID" ]; then
              echo "‚ö†Ô∏è  No mapping found for $FILENAME, skipping."
              SUMMARY="${SUMMARY}| ‚ö†Ô∏è | \`$FILENAME\` | skipped (no mapping) |\n"
              continue
            fi

            echo "::notice::JQ_VALIDATE_START"
            # Validate JSON before sending
            if ! jq empty "$FILE" 2>/tmp/jq_err.txt; then
              JQ_ERR=$(cat /tmp/jq_err.txt)
              echo "::error::JQ_FAIL=$JQ_ERR"
              echo "‚ùå Invalid JSON in $FILENAME: $JQ_ERR"
              exit 1
            fi
            echo "::notice::JQ_VALIDATE_OK"

            # Read whether the workflow should be active
            SHOULD_BE_ACTIVE=$(jq -r '.active // true' "$FILE")
            echo "::notice::ACTIVE=$SHOULD_BE_ACTIVE"

            echo "üì§ Updating workflow '$FILENAME' (ID: $WORKFLOW_ID)..."

            # Deactivate first ‚Äî n8n validates sub-workflow refs when updating active workflows
            echo "‚è∏Ô∏è  Deactivating before update..."
            curl -s -o /dev/null --max-time 30 \
              -X POST "$N8N_URL/api/v1/workflows/$WORKFLOW_ID/deactivate" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" || true

            # Whitelist: only send fields n8n PUT API expects
            jq '{name,nodes,connections,settings:(.settings|del(.maxConcurrency,.availableInMCP))} + if .staticData != null then {staticData} else {} end' "$FILE" > /tmp/payload.json

            HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              --max-time 30 \
              -X PUT "$N8N_URL/api/v1/workflows/$WORKFLOW_ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              -d @/tmp/payload.json)

            echo "::notice::PUT_HTTP=$HTTP_STATUS"
            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "‚úÖ Updated $FILENAME (HTTP $HTTP_STATUS)"
            else
              echo "::error::PUT_FAIL HTTP=$HTTP_STATUS n8n=$(head -c 500 /tmp/response.json)"
              echo "‚ùå Failed to update $FILENAME (HTTP $HTTP_STATUS)"
              cat /tmp/response.json
              SUMMARY="${SUMMARY}| ‚ùå | \`$FILENAME\` | update failed (HTTP $HTTP_STATUS) |\n"
              echo "## ‚ùå Deploy Error" >> $GITHUB_STEP_SUMMARY
              echo "**File:** \`$FILENAME\` | **HTTP:** $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat /tmp/response.json >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            # Activate or deactivate based on the 'active' field in the JSON
            if [ "$SHOULD_BE_ACTIVE" = "true" ] || [ "$SHOULD_BE_ACTIVE" = "True" ]; then
              echo "‚ñ∂Ô∏è  Activating '$FILENAME'..."
              ACT_STATUS=$(curl -s -o /tmp/act_response.json -w "%{http_code}" \
                --max-time 30 \
                -X POST "$N8N_URL/api/v1/workflows/$WORKFLOW_ID/activate" \
                -H "X-N8N-API-KEY: $N8N_API_KEY")
              ACT_LABEL="activated"
            else
              echo "‚è∏Ô∏è  Keeping '$FILENAME' deactivated (active=false in JSON)..."
              ACT_STATUS=$(curl -s -o /tmp/act_response.json -w "%{http_code}" \
                --max-time 30 \
                -X POST "$N8N_URL/api/v1/workflows/$WORKFLOW_ID/deactivate" \
                -H "X-N8N-API-KEY: $N8N_API_KEY")
              ACT_LABEL="deactivated"
            fi

            if [ "$ACT_STATUS" -ge 200 ] && [ "$ACT_STATUS" -lt 300 ]; then
              echo "‚úÖ Workflow '$FILENAME' $ACT_LABEL (HTTP $ACT_STATUS)"
              SUMMARY="${SUMMARY}| ‚úÖ | \`$FILENAME\` | updated & $ACT_LABEL |\n"
            else
              echo "‚ùå Failed to $ACT_LABEL $FILENAME (HTTP $ACT_STATUS)"
              cat /tmp/act_response.json
              SUMMARY="${SUMMARY}| ‚ùå | \`$FILENAME\` | $ACT_LABEL failed (HTTP $ACT_STATUS) |\n"
              exit 1
            fi

          done <<< "${{ steps.changed.outputs.files }}"

          # Write job summary
          echo "## n8n Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Workflow | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          printf "$SUMMARY" >> $GITHUB_STEP_SUMMARY

      - name: No workflow changes detected
        if: steps.changed.outputs.files == ''
        run: |
          echo "‚ÑπÔ∏è  No workflow files changed, nothing to deploy."
          echo "## n8n Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "No workflow files changed in this push." >> $GITHUB_STEP_SUMMARY
